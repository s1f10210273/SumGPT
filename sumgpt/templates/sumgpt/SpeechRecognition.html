<!DOCTYPE html>
{% extends "sumgpt/base.html" %}

{% block title_block %}
index
{% endblock %}

{% block body_block %}
<div class="container">
    <div class="row mt-5">
        <div class="col-md-6 offset-md-3">
            <div class="mb-3">
                <h1 class="bold-text text-center">SumGPT</h1>
                <button id="startButton" class="btn btn-secondary">éŸ³å£°èªè­˜é–‹å§‹</button>
                <button id="stopButton" class="btn btn-danger" style="display:none;">éŸ³å£°èªè­˜çµ‚äº†</button>
                <button id="rec" class="btn btn-danger" type="button" disabled style="display:none;">
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                    éŒ²éŸ³ä¸­
                </button>


                {% comment %} æ¥­ç•ŒæŒ‡å®šã®å®Ÿè£… {% endcomment %}
                <select id="inputState" class="form-select">
                    <option selected>æ¥­ç•Œã‚’æŒ‡å®š</option>
                    {% comment %} ä¸‹ã®[selectedOption]ã«ã¯ã€ã“ã®valueã®å€¤ãŒå…¥ã‚‹ {% endcomment %}
                    <option value="1">ã‚µãƒ³ãƒ—ãƒ«1</option>
                    <option value="2">ã‚µãƒ³ãƒ—ãƒ«2</option>
                    {% comment %} æ¥­ç•Œã‚’å¢—ã‚„ã—ã¦ã„ããŸã„ã§ã™ã­ğŸ˜€ {% endcomment %}
                </select>


            </div>
            <div class="mb-3">
                <form method="post" action="{% url 'sp' %}">
                {% csrf_token %}
                <textarea name="data" id="re" class="form-control" cols="30" rows="10" readonly></textarea>
                <button type="submit" id="sumButton" class="btn btn-secondary" style="display:none;">è¦ç´„</button>
            </form>
            </div>
            <div id="transcription" class="mt-3"></div>
        </div>
    </div>
</div>

<script>
        let isRecognizing = false;
        //APIã®åˆæœŸè¨­å®š
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = true;
        recognition.continuous = true;

        //DOMè¦ç´ ã®èª­ã¿è¾¼ã¿
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const rec = document.getElementById('rec');
        const sumButton = document.getElementById('sumButton');
        const re = document.getElementById('re');

        //ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®æ“ä½œ
        startButton.addEventListener('click', () => {
            isRecognizing = false;
            if (!isRecognizing) {


                    //å˜èªç™»éŒ²
                    const grammar = '#JSGF V1.0 JIS ja; grammar numbers; public <numbers> = æ±ºå®š | åˆ¤æ–­ | ç†ç”± | æ¡ˆä»¶ | å¦æ±º | å†æ¤œè¨ | å†èª¿æ•´ | ä¿ç•™ | è³‡æ–™ | è£œè¶³è³‡æ–™ | å‚è€ƒæ„è¦‹ | ç¤¾é•·ä¸€ä»» | ã‚¢ã‚µã‚¤ãƒ³ ;';

                    const SpeechGrammarList = window.webkitSpeechGrammarList || window.SpeechGrammarList;
                    const speechRecognitionList = new SpeechGrammarList();
                    speechRecognitionList.addFromString(grammar, 1);

                    //æ¥­ç•Œé¸æŠã‚’ã—ãŸå ´åˆã®å‡¦ç†
                    const selectElement = document.getElementById("inputState");
                    const selectedOption = selectElement.options[selectElement.selectedIndex].value;
                    if (selectedOption == 1) {
                        const customGrammar = '#JSGF V1.0 JIS ja; grammar numbers; public <numbers> = æ±ºå®š | åˆ¤æ–­ | ç†ç”± | æ¡ˆä»¶ | å¦æ±º | å†æ¤œè¨ | å†èª¿æ•´ | ä¿ç•™ | è³‡æ–™ | è£œè¶³è³‡æ–™ | å‚è€ƒæ„è¦‹ | ç¤¾é•·ä¸€ä»» | ã‚¢ã‚µã‚¤ãƒ³ ;';
                        speechRecognitionList.addFromString(customGrammar, 1);
                        }

                    else if (selectedOption == 2) {
                        const customGrammar = '#JSGF V1.0 JIS ja; grammar numbers; public <numbers> = æ±ºå®š | åˆ¤æ–­ | ç†ç”± | æ¡ˆä»¶ | å¦æ±º | å†æ¤œè¨ | å†èª¿æ•´ | ä¿ç•™ | è³‡æ–™ | è£œè¶³è³‡æ–™ | å‚è€ƒæ„è¦‹ | ç¤¾é•·ä¸€ä»» | ã‚¢ã‚µã‚¤ãƒ³ ;';
                        speechRecognitionList.addFromString(customGrammar, 1);
                        }
                    //é¸æŠæ¥­ç•Œã‚’å¢—ã‚„ã™ã¨ãã¯ã“ã®ã—ãŸã«æ›¸ã„ã¦ã„ãã®ãŒã„ã„ã‹ã‚‚ï¼ï¼
                    //ä¸Šã®else ifæ–‡ã‚’ã‚³ãƒ”ãƒšã§ã„ã‘ã¾ã™
                    recognition.grammars = speechRecognitionList;



                    console.log(selectedOption);
                    recognition.start();
                    //ä¸‹ã®é–¢æ•°ã®å‘¼ã³å‡ºã—
                    startrec();
                    startButton.style.display = 'none';
                    stopButton.style.display = 'inline-block';
                    rec.style.display = 'inline-block';
                    }
                });

        //ã‚¹ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®æ“ä½œ
        stopButton.addEventListener('click', () => {
            //ä¸‹ã®é–¢æ•°ã®å‘¼ã³å‡ºã—
            stoprec();
        });

        function startrec() {
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + '\n';
                    } else {
                        interimTranscript += transcript + ' ';
                    }
                }

                document.getElementById('transcription').textContent = interimTranscript.trim();
                re.value = (re.value + finalTranscript).trim() + "\n";
    }
}

        function stoprec() {
            recognition.stop();
            startButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
            rec.style.display = 'none';
            isRecognizing = true;
            if (re.value != '') {
            sumButton.style.display = 'inline-block';
            }
        }

</script>


{% endblock %}